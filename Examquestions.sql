
--IBM DB2 SQL

--DDL

CREATE DATABASE COMSALDB;
CONNECT TO COMSALDB;

CREATE TABLE STAFF (
	STAFFID VARCHAR(5) PRIMARY KEY NOT NULL,
	STAFFNAME VARCHAR(15),
	GENDER CHAR(1) CHECK (GENDER IN ('M', 'F')),
	POSITION VARCHAR(30) CHECK (POSITION IN ('Manager','Assistant Manager', 'Executive')),
	DATEJOIN DATE,
	CONTACTNO VARCHAR(15),
	BASICSAL DECIMAL (6,2)
);

INSERT INTO STAFF VALUES ('S0001','Jonny Dep','M','Manager','2013-12-01','0123337777',6000);
INSERT INTO STAFF VALUES ('S0002','Katy Pery','F','Assistant Manager','1999-07-01','0134441119',2000);
INSERT INTO STAFF VALUES ('S0003','Tom Jone','M','Executive','1998-01-20','0122246955',1500);


CREATE TABLE ORDER (
	ORDERID INT PRIMARY KEY NOT NULL,
	ORDERDATE DATE,
	STAFFID VARCHAR(5),
	FOREIGN KEY (STAFFID) REFERENCES  STAFF
);

INSERT INTO ORDER VALUES (1,'2002-01-13','S0002');
INSERT INTO ORDER VALUES (2,'2002-05-10','S0001');
INSERT INTO ORDER VALUES (3,'2002-08-02','S0002');
INSERT INTO ORDER VALUES (4,'2003-01-01','S0003');
INSERT INTO ORDER VALUES (5,'2003-03-03','S0001');
INSERT INTO ORDER VALUES (7,'2003-12-03','S0001');

CREATE TABLE ITEM (
	ITEMID VARCHAR(3) PRIMARY KEY NOT NULL,
	ITEMDESCRIBPT VARCHAR(20),
	QTYONHAND INT,
	MIN_QIY INT,
	ITEMPRICE DECIMAL (5,2),
	REORDER INT
);

INSERT INTO ITEM VALUES ('002','Graphic Card',11,5,250,0);
INSERT INTO ITEM VALUES ('003','Pen Drive',22,15,70,0);
INSERT INTO ITEM VALUES ('001','USB Port',18,10,20,0);
INSERT INTO ITEM VALUES ('004','DDR Ram',9,5,60,0);
INSERT INTO ITEM VALUES ('005','CD',13,5,15,0);

CREATE TABLE ORDERITEM (
	ORDERID INT NOT NULL,
	ITEMID VARCHAR(3) NOT NULL,
	QUANTITY INT,
	AMOUNT DECIMAL (6,2),
	PRIMARY KEY (ORDERID, ITEMID),
	FOREIGN KEY (ORDERID) REFERENCES ORDER,
	FOREIGN KEY (ITEMID) REFERENCES  ITEM
);

INSERT INTO ORDERITEM VALUES (1,'002',3,750);
INSERT INTO ORDERITEM VALUES (2,'005',1 , 15);
INSERT INTO ORDERITEM VALUES (3,'003',3,211.50);
INSERT INTO ORDERITEM VALUES (4,'002',5,1250);
INSERT INTO ORDERITEM VALUES (5,'001',5,100);


--DML

INSERT INTO ORDER VALUES (6,'2003-01-03','S0002');
INSERT INTO ORDERITEM VALUES (6,'002',2,5000);

-- List  out All the details of the Staff that joined BEFORE year 2000

SELECT * FROM STAFF
	WHERE YEAR(DATEJOIN) < 2000;

-- Create a View that can show the number of order for every staff

CREATE VIEW ORDERNO AS
	SELECT STAFFNAME, COUNT(ORDER.STAFFID) AS ORDERNUM
		FROM STAFF, ORDER
		WHERE ORDER.STAFFID = STAFF.STAFFID
		GROUP BY STAFFNAME;

SELECT * FROM ORDERNO

--Create a trigger to update QTYONHAND in the ITEM  table automatically AFTER inserting a record into ORDERITEM


CREATE TRIGGER UPDATE_QITYONHAND
AFTER INSERT ON ORDERITEM
FOR EACH ROW MODE DB2SQL

BEGIN

CREATE VIEW BARANI AS 
SELECT  ITEM.ITEMID, ITEMDESCRIBPT, QUANTITY,QTYONHAND 
	FROM ITEM, ORDERITEM
	WHERE ITEM.ITEMID = ORDERITEM.ITEMID;

UPDATE BARANI
	SET QTYONHAND = QTYONHAND - QUANTITY
WHERE ORDERITEM.ITEMID = ITEM.ITEMID;

END;


